<div>
  <div ng-if="qa.proxyMessage">
    <div uib-alert type="info" close="dismissProxy(qa)">
      <span message key="{{qa.proxyMessage}}"></span>
    </div>
  </div>

  <div ng-class="{'panel-container': true, 'revoked-certificate' : certProperties.isRevoked}">

    <div class="qa-panel" id="qa{{panelId}}-{{qa.internReferens}}" ng-show="!qa.proxyMessage">

      <!-- Header -->
      <div ng-if="qa.status == 'CLOSED'">
        <h3 class="inline-block">
          Ämne: <strong><span message key="qa.amne.{{qa.amne | lowercase}}"></span></strong><span
            id="fkMeddelandeRubrik-{{qa.internReferens}}"
            ng-show="qa.meddelandeRubrik"> - {{qa.meddelandeRubrik}}</span>
        </h3>
        <label class="checkbox" ng-if="!certProperties.kompletteringOnly">
          <input type="checkbox" ng-model="handledFunction" ng-model-options="{ getterSetter: true }">
          Hanterad
        </label>
      </div>

      <div class="row">
        <div class="col-xs-9" ng-if="qa.status != 'CLOSED'">
          <div class="status-header">
            <h3 class="inline-block">
              Ämne: <strong><span message key="qa.amne.{{qa.amne | lowercase}}"></span></strong><span
                id="fkMeddelandeRubrik-{{qa.internReferens}}"
                ng-show="qa.meddelandeRubrik"> - {{qa.meddelandeRubrik}}</span>
            </h3>
            <h3>
              Åtgärd: <strong><span message key="qa.measure.{{qa.measureResKey}}"></span></strong>
            </h3>
            <h3 ng-show="qa.sistaDatumForSvar">
              Svara senast: <strong>{{qa.sistaDatumForSvar}}</strong></h3>
            <label class="checkbox" ng-if="!certProperties.kompletteringOnly">
              <input type="checkbox" ng-model="handledFunction" ng-model-options="{ getterSetter: true }">
              Hanterad
            </label>
          </div>
        </div>
      </div>
      <div class="row" ng-if="!certProperties.kompletteringOnly">
        <div class="col-xs-9"></div>
        <div wc-authority="VIDAREBEFORDRA_FRAGASVAR" class="col-xs-3 form-inline qa-panel__vidarebefordra-placement"
             ng-show="!certProperties.isRevoked">
          <!--  status header -->
          <button type="button" id="{{panelId}}-vidarebefordraEjHanterad" class="btn pull-right"
                  ng-class="{'btn-info': !qa.vidarebefordrad, 'btn-default btn-secondary' : qa.vidarebefordrad}"
                  title="Skicka mejl med en länk till intyget för att informera den som ska hantera frågan-svaret."
                  ng-click="openMailDialog(qa)" ng-show="!certProperties.isRevoked">
            <img ng-if="!qa.vidarebefordrad" src="/img/mail.png"> <img ng-if="qa.vidarebefordrad"
                                                                       src="/img/mail_dark.png">
          </button>
          <label for="{{panelId}}-mark-as-notified-{{qa.internReferens}}" class="checkbox-inline padding-top-small">
            <input id="{{panelId}}-mark-as-notified-{{qa.internReferens}}" type="checkbox"
                   ng-disabled="qa.forwardInProgress" ng-model="qa.vidarebefordrad"
                   ng-change="onVidareBefordradChange(qa)" /> Vidarebefordrad</label> <span
            ng-if="qa.forwardInProgress"> <img src="/img/ajax-loader-kit-16x16.gif"></span>
        </div>
      </div>

      <!-- Frågan -->
      <div class="panel-container">
        <div class="qa-block"
             ng-class="{'qa-block-handled' : qa.status == 'ANSWERED', 'qa-block-fk' : (qa.frageStallare | lowercase) == 'fk', 'qa-block-wc' : (qa.frageStallare | lowercase) == 'wc'}">
          <div class="qa-block-head clearfix">
            <div class="pull-left" ng-switch="qa.frageStallare | lowercase">
              Från: <span class="qa-sender" ng-switch-when="wc"
                          id="{{panelId}}-question-fraga-vard-aktor-namn-{{qa.internReferens}}">{{qa.vardAktorNamn}}</span>
              <span ng-switch-default message key="qa.fragestallare.{{qa.frageStallare | lowercase}}"></span>
              <div id="{{panelId}}-fkKontakter-{{qa.internReferens}}" ng-repeat="kontakt in qa.externaKontakter">
                {{kontakt}}<br />
              </div>
            </div>
            <!-- Fraga fran fk eller wc? -->
            <div class="pull-right" ng-switch="qa.frageStallare | lowercase">
              <span ng-switch-when="wc">Skickat: </span> <span ng-switch-default>Mottaget: </span> <span class="qa-date"
                                                                                                         id="{{panelId}}-qa-skickaddatum-{{qa.internReferens}}">{{qa.frageSkickadDatum | date:'short'}}</span>
            </div>
          </div>

          <div class="qa-block-body" id="{{panelId}}-qa-fragetext-{{qa.internReferens}}">{{qa.frageText}}</div>
          <div class="qa-block-body komplettera-block" id="{{panelId}}-fkKompletteringar-{{qa.internReferens}}"
               ng-repeat="komplettering in qa.kompletteringar">
            <strong><span>{{komplettering.falt}}</span></strong>
            <div>
              <span>{{komplettering.text}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- error message occuring when inteacting with server for komplettering-->
      <div id="internal-{{qa.internReferens}}-svarsText-load-error" ng-show="qa.activeErrorMessageKey"
           class="alert alert-danger">
        <span message key="fk7263.error.{{qa.activeErrorMessageKey}}"></span>
      </div>

      <!-- Svara med nytt intyg button - only on komplettering -->
      <div ng-if="qa.svaraMedNyttIntygDisabled == true && qa.svaraMedNyttIntygDisabledReason && !hasStatus(qa, 'CLOSED')">
        <div class="alert alert-warning">
          {{qa.svaraMedNyttIntygDisabledReason}}
        </div>
      </div>

      <div id="answerDisabledReasonPanel" class="alert alert-info" ng-show="isNotAllowedToAnswer(qa)">
        {{qa.answerDisabledReason}}
      </div>

      <div class="buttonbar" ng-show="isKompletteringAllowed(qa, certProperties)">
        <button type="button" class="btn" ng-if="!qa.svaraMedNyttIntygDisabled && qa.status != 'CLOSED'"
                ng-class="{'btn-success': qa.status != 'CLOSED' && !showAnswerField, 'btn-default btn-secondary': qa.status == 'CLOSED' || showAnswerField}"
                ng-click="openKompletteringDialog(qa, cert)" ng-disabled="showAnswerField" wc-check-vardenhet
                vardenhet="{{viewState.intygModel.grundData.skapadAv.vardenhet.enhetsid}}"
                id="answerWithIntygBtn-{{qa.internReferens}}">
          <img src="/img/loader-small-green.gif" ng-show="qa.updateInProgress"> Svara
        </button>
      </div>

      <!-- Svarsdelen -->
      <div
          ng-if="isAllowedToAnswerAtAll(qa, certProperties)"
          class="fold-animation">
        <div class="panel-container" ng-show="qa.amne != 'PAMINNELSE'">
          <div class="qa-block"
               ng-class="{'qa-block-handled': qa.status == 'CLOSED', 'qa-block-fk' : (qa.frageStallare | lowercase) == 'wc', 'qa-block-wc' : (qa.frageStallare | lowercase) == 'fk'}"
               ng-if="(qa.status == 'CLOSED' && qa.svarsText) || (qa.status == 'ANSWERED')">

            <!-- UNHANDLEDTYPE: frågan är redan BESVARAD -->
            <!-- HANDLEDTYPE: frågan har en svarstext -->
            <div class="qa-block-head clearfix">
              <div class="pull-left" ng-switch="qa.frageStallare | lowercase">
                <!--  Frågaställaren var Vårdenheten - svaret måste kommit från FK -->
                Från: <span ng-switch-when="wc">
                          <span class="qa-sender" message key="qa.fragestallare.fk"></span>
                        </span>
                <!--  Frågaställaren var inte Vårdenheten - svaret måste alltså kommit från Vårdenheten -->
                <span ng-switch-default id="{{panelId}}-answer-svar-vard-aktor-namn-{{qa.internReferens}}"
                      class="qa-sender">{{qa.vardAktorNamn}}</span>
              </div>
              <div class="pull-right" ng-switch="qa.frageStallare | lowercase">
                <!-- motsatt villkor mot frågan -->
                <span ng-switch-when="wc">Mottaget: </span> <span ng-switch-default>Skickat: </span> <span
                  class="qa-date">{{qa.svarSkickadDatum | date:'short'}}</span>
              </div>
            </div>
            <div id="{{panelId}}-{{qa.internReferens}}-svarsText" class="qa-block-body">{{qa.svarsText}}</div>
          </div>
        </div>

        <!-- KNAPPAR HANTERADE FRÅGOR -->
        <!-- error message occuring when inteacting with server for this FragaSvar-->
        <!--  Oavsett hur frågan stänged skall man kunna 'öppna' den igen -->
        <!--div ng-if="qa.status == 'CLOSED'">
          <div id="{{panelId}}-{{qa.internReferens}}-svarsText-load-error" ng-show="qa.activeErrorMessageKey" class="alert alert-danger">
            <span message key="fk7263.error.{{qa.activeErrorMessageKey}}"></span>
          </div>
          <div class="form-group">
            <div class="controls" ng-hide="qa.frageStallare!='WC' && qa.svarsText">
              <button type="button" class="btn btn-default btn-secondary" ng-click="updateAsUnHandled(qa)"
                      wc-check-vardenhet vardenhet="{{viewState.intygModel.grundData.skapadAv.vardenhet.enhetsid}}"
                      id="markAsUnhandledBtn-{{qa.internReferens}}" ng-disabled="qa.updateHandledStateInProgress">
                <img src="/img/loader-small.gif" ng-show="qa.updateHandledStateInProgress"> Markera som ej hanterad
              </button>
            </div>
          </div>
        </div-->

        <!-- KNAPPAR EJ HANTERADE FRÅGOR -->
        <!-- TA BORT certProperties.kompletteringOnly NÄR "SVAR SOM FÖLJER MED" ÄR IMPLEMENTERAT -->

        <div ng-if="showNotHandledButtons(qa, certProperties)">
          <div class="form-group" ng-if="hasStatus(qa, 'PENDING_INTERNAL_ACTION')">
            <!--  VÄNTAR på svar från Vårdenheten, men skall kunna klarmarkeras ändå?-->

            <!-- Rubrik: Svar -->
            <label class="control-label" ng-show="isAllowedToAnswer(qa, certProperties)">Svar</label>

            <!-- ELLER inforuta komplettering EJ IMPLEMENTERAT
            <div class="alert alert-info"
                 ng-show="certProperties.kompletteringOnly">
              Här kan du föra en dialog med Försäkringskassan om ett intyg. Medicinsk information ska endast skickas via signerade intyg. När du signerat och skickar intyget till Försäkringskassan följer ditt meddelande som du skrivit med.
            </div> -->

            <div class="controls">
              <div class="form-group" ng-show="isAllowedToAnswer(qa, certProperties)">
                <textarea wc-maxlength ng-trim="false" rows="13" maxlength="5000"
                          class="form-control col-md-9 qa-block-wc" ng-model="qa.svarsText"
                          id="answerText-{{qa.internReferens}}"></textarea>
              </div>
              <div class="webcert-top-padding-section">
                <!-- error message occuring when inteacting with server for this FragaSvar-->
                <div id="internal-{{qa.internReferens}}-svarsText-load-error" ng-show="qa.activeErrorMessageKey"
                     class="alert alert-danger">
                  <span message key="fk7263.error.{{qa.activeErrorMessageKey}}"></span>
                </div>

                <button type="button" class="btn btn-success" ng-click="sendAnswer(qa)"
                        ng-disabled="!qa.svarsText || qa.updateInProgress"
                        ng-show="!qa.answerDisabled && !certProperties.isRevoked" wc-check-vardenhet
                        vardenhet="{{viewState.intygModel.grundData.skapadAv.vardenhet.enhetsid}}"
                        id="sendAnswerBtn-{{qa.internReferens}}">
                  <img src="/img/loader-small-green.gif" ng-show="qa.updateInProgress"> Skicka svar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>
